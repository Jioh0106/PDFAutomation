<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
  
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="context-path" th:content="${contextPath}">
	<title>PDF Automation</title>
	<!-- Bootstrap CSS CDN -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<!-- TOAST UI CSS CDN -->
	<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
	<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
	
	<style>
		@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap');
		* {
		     font-family: "Noto Sans KR", sans-serif; 
		     font-size: 18px;
		}
		.tui-grid-cell {
			background-color: #ffffff !important;
		}
		
		body {
			padding: 30px;
		}
		
		#main {
			width: 1200px;
			margin: auto;
			margin-bottom: 100px;
		}
		
		h3 {
			font-weight: bolder;
		}
		
		#export-btn {
			margin-left: 520px;
		}
		
		.topBtn {
			height: 40px !important;
		}
		
		#back-btn {
			margin-left: 300px;
		}
		
		.card {
			margin: auto;
		}
		
		.header {
			margin: auto;
			margin-left: 100px;
			margin-bottom: 20px;
		}
	</style>
</head>
<body>
	<div id="main">
		<div class="header">
			<div class="d-flex flex-row">
				<h3 class="mb-4">ì‹œê³µì‚¬ ì •ë³´ ì¡°íšŒ</h3>
				<button type="button" class="btn btn-secondary topBtn" id="back-btn" onclick="history.back()">ë’¤ë¡œê°€ê¸°</button>
				<button type="button" class="btn btn-success topBtn ms-3" id="export-btn">ì—‘ì…€ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ</button>
			</div>
			<p>ë‚´ìš©ì„ ìˆ˜ì •í•  ê²½ìš° í•´ë‹¹ ì¹¸ ë”ë¸” í´ë¦­í•´ì„œ ì…ë ¥ ëª¨ë“œ â–¶ ë‚´ìš© ìˆ˜ì • í›„ ì—”í„° â–¶ ìˆ˜ì •ì´ ëª¨ë‘ ì™„ë£Œë˜ë©´ ìˆ˜ì • ì™„ë£Œ ë²„íŠ¼ í´ë¦­</p>
		</div>	
		
		<!-- ì‚¬ì—… + ì‹œê³µì‚¬ ìˆ˜ë§Œí¼ ê·¸ë¦¬ë“œ ìƒì„±  -->
		<div th:each="data : ${selectList}" class="card mb-5" style="width: 60rem;">
		    <!-- ê³µì‚¬ëª… ë™ì  ì„¤ì • -->
		    <h5 class="card-header" th:text="${data['ê³µì‚¬ëª…']}"></h5>
		    <div class="card-body p-3">
		        <div class="row m-3" id="basic-table">
		            <!-- id ê°’: "ì‹œê³µì‚¬ + grid" -->
		            <div th:id="${data['ì‹œê³µì‚¬']} + 'grid'"></div>
		        </div>
		        <!-- ë²„íŠ¼ id ê°’: "ì‹œê³µì‚¬-update" -->
		        <button type="button" class="btn btn-warning float-end" th:id="${data['ì‹œê³µì‚¬']} + '-update'">
		            ìˆ˜ì • ì™„ë£Œ
		        </button>
		    </div>
		</div>

		
		<div class="d-flex justify-content-end me-5 pe-5">
			<button type="button" class="btn btn-outline-danger topBtn" onclick="">ì‹œê³µì‚¬ ì¶”ê°€í•˜ê¸°</button>
		</div>
	 </div>
	 
	<!-- Bootstrap JS CDN -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	<!-- TOAST UI JS CDN -->
	<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
	<!-- ì œì´ì¿¼ë¦¬ -->
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	<!--Axios -->
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	
	<script th:inline="javascript">
		const basePath = window.location.pathname.split('/')[1];  // ë™ì  ì»¨í…ìŠ¤íŠ¸ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
		const apiBase = `/${basePath}/api`;
		// <meta> íƒœê·¸ì—ì„œ context-path ê°€ì ¸ì˜¤ê¸°
		const contextPath = document.querySelector("meta[name='context-path']").getAttribute("content");
		
		const selectList = /*[[${selectList}]]*/[];
		
		$(function () {
			console.log("apiBase = " + apiBase);
			console.log("contextPath = " + contextPath);
			
			
			
			let grids = {};
			selectList.forEach(data => {
	            let company = data['ì‹œê³µì‚¬'];  // ì‹œê³µì‚¬ëª… (ex: REGION_1, REGION_2 ...)
	            let gridId = company + "grid"; // ex: "REGION_1grid"
	            let buttonId = company + "-update"; // ex: "REGION_1-update"

	            // TOAST UI Grid ìƒì„± ë° ì €ì¥
	            grids[company] = new tui.Grid({
	                el: document.getElementById(gridId),
	                data: [],
	                columns: [
	                    {header: 'ìˆœë²ˆ', name: 'ìˆœë²ˆ', width: '100'},
	                    {header: 'í•„ë“œëª…', name: 'í•„ë“œëª…', editor: 'text', width: '150'},
	                    {header: 'ê°’', name: 'ê°’', editor: 'text', width: '300'}
	                ],
	                editing: true
	            });

	            // "ìˆ˜ì • ì™„ë£Œ" ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë™ì  ë°”ì¸ë”©
	            $('#' + buttonId).on('click', function () {
	                const modifiedRows = grids[company].getModifiedRows();
	                if (invalid(modifiedRows)) {
	                    update(grids[company], modifiedRows);
	                }
	            });
	        });
			
			
			// ê·¸ë¦¬ë“œ ë°ì´í„° ì´ˆê¸°í™”
			
			axios.get(`${apiBase}/get/info`, { params: { type: "region" } })
		    .then(response => {
		        console.log("âœ… ì„œë²„ ì‘ë‹µ ë°ì´í„°:", response.data);
		        
		        if (response.data) {
		            Object.keys(grids).forEach((company, index) => {
		                let sheetKey = company;
		                console.log(`ğŸ” í™•ì¸ ì¤‘ì¸ sheetKey: ${sheetKey}, ë°ì´í„°:`, response.data[sheetKey]);

		                if (response.data[sheetKey]) {
		                    let formattedData = response.data[sheetKey].map(item => ({
		                        ìˆœë²ˆ: item.ìˆœë²ˆ,
		                        í•„ë“œëª…: item.í•„ë“œëª…,
		                        ê°’: item.ê°’
		                    }));

		                    console.log(`âœ… ë³€í™˜ëœ ë°ì´í„° (${company}):`, formattedData);
		                    
		                    grids[company].resetData(formattedData);

		                    setTimeout(() => {
		                        grids[company].refreshLayout();
		                        console.log(`ğŸ”„ ${company} ê·¸ë¦¬ë“œ UI ì—…ë°ì´íŠ¸ ì™„ë£Œ!`);
		                    }, 100);
		                } else {
		                    console.warn(`âš ï¸ ${sheetKey} ë°ì´í„°ê°€ ì—†ìŒ`);
		                }
		            });
		        } else {
		            console.error("âŒ ì„œë²„ ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
		        }
		    })
		    .catch(error => {
		        console.error("âŒ ì—ëŸ¬ ë°œìƒ:", error);
		    });


			// "ì—‘ì…€ ë‹¤ìš´ë¡œë“œ" ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ 
			$('#export-btn').on('click', function () {
				console.log('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­');
			    window.location.href = `${apiBase}/info/download?type=region`;
			});
		
			
		}); // ë”ë¡œë“œ ì´ë²¤íŠ¸
		
		
		
		// ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
		function invalid(modifiedRows) {
		    console.log("ë³€ê²½ëœ ë°ì´í„°:", modifiedRows);

		    // ìˆ˜ì •ëœ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
		    if (modifiedRows.updatedRows.length === 0) {
		        alert('ìˆ˜ì •ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
		        return false;
		    }

		    // í•„ìˆ˜ í•­ëª© ì¤‘ ë¹ˆ í•„ë“œê°€ ìˆëŠ”ì§€ ê²€ì‚¬
		    const invalidRows = modifiedRows.createdRows.filter(row => {
		        console.log('ê²€ì‚¬ ì¤‘ì¸ í–‰ ë°ì´í„°:', row); // ë””ë²„ê¹…ìš© ì¶œë ¥
		        return (
		            !row.ìˆœë²ˆ || 
		            !row.í•„ë“œëª… || 
		            !row.Xì¢Œí‘œ || 
		            !row.Yì¢Œí‘œ || 
		            !row.í°íŠ¸í¬ê¸° 
		        );
		    });

		    // ë¹ˆ í•„ë“œê°€ ìˆëŠ” í–‰ì´ ì¡´ì¬í•˜ë©´ ì•Œë¦¼ í‘œì‹œ í›„ ì¤‘ë‹¨
		    if (invalidRows.length > 0) {
		        console.log('ìœ íš¨í•˜ì§€ ì•Šì€ í–‰:', invalidRows);
		        alert('ë¹ˆ ì…€ì´ ìˆìŠµë‹ˆë‹¤.');
		        return false;
		    }

		    return true; // ëª¨ë“  ì¡°ê±´ í†µê³¼
		}

		
		function update(grid, modifiedRows) {
		    const payload = {
		        ["grid" + (grid === grid1 ? 1 : grid === grid2 ? 2 : 3) + "Data"]: modifiedRows.updatedRows
		    };

		    axios.post(`${apiBase}/info/update`, payload)
		        .then(function () {
		            alert('ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');

		            // âœ… ìµœì‹  ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ ì ìš©
		            axios.get(`${apiBase}/api/info/check`)
		                .then(function (response) {
		                    const gridKey = "grid" + (grid === grid1 ? 1 : grid === grid2 ? 2 : 3) + "Data";
		                    if (response.data[gridKey]) {
		                        grid.resetData(response.data[gridKey]); // ìµœì‹  ë°ì´í„° ë°˜ì˜
		                    } else {
		                        console.warn("ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
		                    }
		                })
		                .catch(function (error) {
		                    console.error('ìµœì‹  ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
		                });
		        })
		        .catch(function (error) {
		            console.error('ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
		            alert('ë°ì´í„° ì €ì¥ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
		        });
		} // update


		
		
	</script>

</body>
		
</html>